<?xml version="1.0"?>
<project name="vfsStream" default="main">
  <property name="build.base.dir" value="build/build" override="true"/>
  <property name="build.report.dir" value="build/reports" override="true"/>
  <property name="pkg.dir" value="src/main/php/org/bovigo/vfs" />
  <property name="pkg.name" value="vfsStream-${version}"/>
  <property name="build.src.dir" value="${build.base.dir}/${pkg.name}"/>

  <target name="main" if="version" depends="check-style,test-report,create-api-doc,versioncheck,copy-files"/>

  <target name="release" depends="main,package"/>

  <target name="check-style" description="check coding standards">
    <echo>----------------------------------</echo>
    <echo>| Checking CS of source files    |</echo>
    <echo>----------------------------------</echo>
    <exec command="phpcs --standard=stubbles ${pkg.dir}" passthru="true"/>
  </target>

  <target name="test-report" description="run test suite">
    <delete>
      <fileset dir="${build.report.dir}">
        <include name="**"/>
      </fileset>
    </delete>
    <!-- Use command line to get the metrics and pmd data, code coverage report
         by PHPUnit is also more beautiful than Phing's. -->
    <exec passthru="true" command="phpunit --log-metrics ${build.report.dir}/metrics.xml --log-pmd ${build.report.dir}/pmd.xml --coverage-html ${build.report.dir}/coverage src_test_AllTests"/>
  </target>

  <target name="test" description="run test suite">
    <!-- Use command line to get the metrics and pmd data, code coverage report
         by PHPUnit is also more beautiful than Phing's. -->
    <exec passthru="true" command="phpunit src_test_AllTests"/>
  </target>

  <target name="test53" description="run test suite">
    <!-- Use command line to get the metrics and pmd data, code coverage report
         by PHPUnit is also more beautiful than Phing's. -->
    <exec passthru="true" command="phpunit53 src_test_AllTests"/>
  </target>

  <target name="create-api-doc" description="Creates API docs">
    <phpdoc title="vfsStream"
            destdir="${build.report.dir}/api"
            sourcecode="yes"
            output="HTML:frames:DOM/earthli"
            defaultpackagename="bovigo_vfs">
      <fileset dir="src/main/php/org/bovigo/vfs">
        <include name="**/*.php" />
      </fileset>
    </phpdoc>
  </target>

  <target name="versioncheck" unless="version">
    <echo message="====================================================="/>
    <echo message="Version not specified. You must enter a version. In"/>
    <echo message="the future you can add this to build.properties or"/>
    <echo message="enter it on the command line: "/>
    <echo message=" "/>
    <echo message="-Dversion=2.0.0b1"/>
    <echo message="====================================================="/>
    <input propertyname="version" promptChar=":">version</input>
    <property name="pkg.name" value="vfsStream-${version}" override="true"/>
    <property name="build.src.dir" value="${build.base.dir}/${pkg.name}" override="true"/>
  </target>

  <target name="copy-files">
    <echo>-----------------------------</echo>
    <echo>| Creating directory layout |</echo>
    <echo>-----------------------------</echo>
    <delete dir="${build.src.dir}"/>
    <copy file="LICENSE" tofile="${build.src.dir}/LICENSE"/>
    <copy todir="${build.src.dir}/docs">
      <fileset dir="${build.report.dir}">
        <include name="**/*"/>
      </fileset>
    </copy>
    <append destFile="${build.src.dir}/VERSION">vfsStream version ${version}</append>
    <copy todir="${build.src.dir}/vfsStream">
      <fileset dir="src/main/php/org/bovigo/vfs">
        <include name="**/*.php"/>
      </fileset>
    </copy>
    <copy todir="${build.src.dir}/examples">
      <fileset dir="examples">
        <include name="**/*"/>
      </fileset>
    </copy>
  </target>

  <target name="package" description="Build the pear package" depends="versioncheck">
    <!-- Creation of package.xml is in another file because changelog should not
         litter the build file. -->
    <phing phingfile="build/pear.xml" target="package" inheritAll="true"/>
    <exec command="pear package" dir="${build.src.dir}" passthru="true"/>
  </target>
</project>